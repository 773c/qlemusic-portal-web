<template>
  <div id="user-set">
    <el-tabs
      v-model="userSetTabsValue"
      tab-position="left"
      type="border-card"
      style="height: 787px;border: none;border-top:1px solid #e4e4e4;box-shadow: none"
      @tab-click="userSetClickTrigger">
      <el-tab-pane label="è´¦å·è®¾ç½®é¦–é¡µ" name="home">
        <div class="user-set-home-wrapper">
          <div class="ush-row-one-wrapper">
            <div class="ush-text-top">æ‚¨å½“å‰å®‰å…¨è¯„åˆ†ä¸ºï¼š</div>
            <div class="ush-rate">
              <el-rate
                v-model="safeLevel"
                disabled
                show-score
                text-color="#ff9900"
                :colors="colors"
                score-template="{value}">
              </el-rate>
            </div>
            <div class="ush-img">
              <img src="@/assets/images/usr-set-safe.png" width="30" height="27">
            </div>
          </div>
          <div style="clear: both;"></div>
          <!--å®šæœŸä¿®æ”¹å¯†ç -->
          <div class="ush-row-two-wrapper">
            <el-divider content-position="left">
              <div class="ush-title-name">
                <span>å®šæœŸä¿®æ”¹å¯†ç  <i class="el-icon-edit-outline"></i></span>
              </div>
            </el-divider>
            <div class="ush-two-wrapper">
              <div class="usht-img-wrapper">
                <img src="@/assets/images/user-safe-right.png" width="18">
              </div>
              <div class="usht-text-wrapper">
                æ­£å¸¸
              </div>
              <div>
                <el-button style="float: right; padding: 3px 0" type="text" @click="userSetTabsValue = 'password'">ä¿®æ”¹å¯†ç 
                </el-button>
              </div>
            </div>
          </div>
          <div style="clear: both;"></div>
          <!--ç»‘å®šå®‰å…¨æ‰‹æœº-->
          <div class="ush-row-three-wrapper">
            <el-divider content-position="left">
              <div class="ush-title-name">
                <span>ç»‘å®šå®‰å…¨æ‰‹æœº <i class="el-icon-edit-outline"></i></span>
              </div>
            </el-divider>
            <div class="ush-three-wrapper">
              <div class="usht-left">
                <img src="@/assets/images/user-safe-right.png" width="18">
              </div>
              <div class="usht-text-wrapper">
                æ­£å¸¸
              </div>
              <div>
                <el-button style="float: right; padding: 3px 0" type="text" @click="userSetTabsValue = 'telephone'">ç»‘å®šæ‰‹æœº
                </el-button>
              </div>
            </div>
          </div>
          <div style="clear: both;"></div>
          <!--ç»‘å®šå®‰å…¨é‚®ç®±-->
          <div class="ush-row-three-wrapper">
            <el-divider content-position="left">
              <div class="ush-title-name">
                <span>ç»‘å®šå®‰å…¨é‚®ç®± <i class="el-icon-edit-outline"></i></span>
              </div>
            </el-divider>
            <div class="ush-three-wrapper">
              <div class="usht-left">
                <img src="@/assets/images/user-safe-warn.png" width="18">
              </div>
              <div class="usht-text-wrapper" style="color: #FF7436">
                å­˜åœ¨é£é™©
              </div>
              <div>
                <el-button style="float: right; padding: 3px 0" type="text" @click="userSetTabsValue = 'email'">ç»‘å®šé‚®ç®±
                </el-button>
              </div>
            </div>
          </div>
          <div style="clear: both;"></div>
          <!--ç»‘å®šç¬¬ä¸‰æ–¹è´¦å·-->
          <div class="ush-row-three-wrapper">
            <el-divider content-position="left">
              <div class="ush-title-name">
                <span>ç»‘å®šç¬¬ä¸‰æ–¹è´¦å· <i class="el-icon-edit-outline"></i></span>
              </div>
            </el-divider>
            <div class="ush-three-wrapper">
              <div class="usht-left">
                <img src="@/assets/images/user-safe-right.png" width="18">
              </div>
              <div class="usht-text-wrapper">
                æ­£å¸¸
              </div>
              <div>
                <el-button style="float: right; padding: 3px 0" type="text" @click="userSetTabsValue = 'oauth'">ç»‘å®šè´¦å·
                </el-button>
              </div>
            </div>
          </div>
          <div style="clear: both;"></div>
          <!--ç™»å½•è®°å½•-->
          <div class="ush-row-three-wrapper">
            <el-divider content-position="left">
              <div class="ush-title-name">
                <span>ç™»å½•è®°å½• <i class="el-icon-edit-outline"></i></span>
              </div>
            </el-divider>
            <div class="ush-three-wrapper">
              <div class="usht-left">
                <img src="@/assets/images/user-safe-right.png" width="18">
              </div>
              <div class="usht-text-wrapper">
                æ­£å¸¸
              </div>
              <div>
                <el-button style="float: right; padding: 3px 0" type="text" @click="userSetTabsValue = 'record'">ç‚¹å‡»æŸ¥çœ‹
                </el-button>
              </div>
            </div>
          </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="ä¿®æ”¹å¯†ç " name="password">
        <div class="user-set-password-wrapper">
          <div class="us-title-wrapper">
            <el-divider content-position="left"><span>ä¿®æ”¹å¯†ç </span></el-divider>
          </div>
          <div class="us-password-wrapper">
            <el-form :model="pwdRuleForm" status-icon :rules="rules" ref="pwdRuleForm" label-width="100px"
                     class="demo-ruleForm">
              <el-form-item label="æ—§å¯†ç " prop="oldPass">
                <el-input type="password" v-model="pwdRuleForm.oldPass"></el-input>
              </el-form-item>
              <el-form-item label="æ–°å¯†ç " prop="pass">
                <el-input type="password" v-model="pwdRuleForm.pass" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="ç¡®è®¤å¯†ç " prop="checkPass">
                <el-input type="password" v-model="pwdRuleForm.checkPass" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item align="center" style="padding-top: 10px">
                <el-button type="danger" @click="updatePwdHandler('pwdRuleForm')" style="padding: 8px 20px">ä¿®æ”¹
                </el-button>
                <el-button plain @click="resetPwd('pwdRuleForm')" style="padding: 8px 20px">é‡ç½®</el-button>
              </el-form-item>
            </el-form>
          </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="ä¿®æ”¹æ‰‹æœº" name="telephone">
        <div class="user-set-telephone-wrapper">
          <div class="us-title-wrapper">
            <el-divider content-position="left"><span>ä¿®æ”¹æ‰‹æœº</span></el-divider>
          </div>
          <div v-if="!isNextByUpdateTel" class="us-telephone-wrapper">
            <div v-if="userInfo.telephone === null" class="us-telephone-tip">
              Tipï¼šæ‚¨å½“å‰æœªç»‘å®šæ‰‹æœºï¼Œè¯·ç«‹å³ç»‘å®šæé«˜å®‰å…¨å§ ğŸ¥¶
            </div>
            <div v-else class="us-telephone-tip">
              Tipï¼šæ‚¨å½“å‰å·²ç»‘å®šæ‰‹æœºï¼Œå¦‚éœ€ä¿®æ”¹è¯·å®Œæˆä»¥ä¸‹æ“ä½œ ğŸ˜
            </div>
            <el-form label-width="100px">
              <el-form-item label="ç»‘å®šæ‰‹æœºå·">
                <el-input v-model="bindTelephone" type="text" :placeholder="userInfo.telephone | telephoneFormat" style="width: 200px"
                          :disabled="userInfo.telephone === null?false:true"></el-input>
              </el-form-item>
              <el-form-item label="éªŒè¯ç ">
                <el-input type="text" v-model="setVerify" placeholder="è¾“å…¥éªŒè¯ç " style="width: 100px"></el-input>
                <verify-button
                  ref="prevVerifyBtnRef"
                  :telephone="userInfo.telephone"
                  :isSendSuccessTo="isSendSuccess"
                  :vbwidth="92"
                  :vbpadding="{vertical:13,align:0}"
                  @setSendSuccessStatus="setSendSuccessStatus">
                </verify-button>
              </el-form-item>
              <el-form-item style="padding-top: 10px">
                <el-button v-if="userInfo.telephone !== null" type="danger" @click="updateTelNextHandler" style="padding: 8px 20px;margin-left: 30px">ä¸‹ä¸€æ­¥
                </el-button>
                <el-button v-else type="danger" @click="bindTelHandler" style="padding: 8px 20px;margin-left: 30px">ç»‘å®š
                </el-button>
              </el-form-item>
            </el-form>
          </div>
          <div v-else class="us-telephone-wrapper">
            <el-form label-width="100px">
              <el-form-item label="è¾“å…¥æ–°æ‰‹æœº">
                <el-input type="text" v-model="setTelephone" placeholder="è¾“å…¥æ–°æ‰‹æœº" style="width: 200px"></el-input>
              </el-form-item>
              <el-form-item label="éªŒè¯ç ">
                <el-input type="text" v-model="setVerify" placeholder="è¾“å…¥éªŒè¯ç " style="width: 100px"></el-input>
                <verify-button
                  v-if="isNextByUpdateTel"
                  :telephone="setTelephone"
                  :isSendSuccessTo="isSendSuccess"
                  :vbwidth="92"
                  :vbpadding="{vertical:13,align:0}"
                  @setSendSuccessStatus="setSendSuccessStatus">
                </verify-button>
              </el-form-item>
              <el-form-item style="padding-top: 10px">
                <el-button type="danger" @click="updateTelHandler" style="padding: 8px 20px;margin-left: 30px">ä¿®æ”¹
                </el-button>
              </el-form-item>
            </el-form>
          </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="ç»‘å®šé‚®ç®±" name="email">
        <div class="user-set-email-wrapper">
          <div class="us-title-wrapper">
            <el-divider content-position="left"><span>ç»‘å®šé‚®ç®±</span></el-divider>
          </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="ç»‘å®šè´¦å·" name="oauth">
        <div class="user-set-oauth-wrapper">
          <div class="us-title-wrapper">
            <el-divider content-position="left"><span>ç»‘å®šè´¦å·</span></el-divider>
          </div>
        </div>
      </el-tab-pane>
      <el-tab-pane label="ç™»å½•è®°å½•" name="record">
        <div class="user-set-record-wrapper">
          <div class="us-title-wrapper">
            <el-divider content-position="left"><span>ç™»å½•è®°å½•</span></el-divider>
          </div>
        </div>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>

<script>
  import {mapGetters} from 'vuex'
  import {updatePassword, updateTelephone} from "@/api/usetSet";
  import VerifyButton from '@/components/VerifyButton'

  export default {
    name: "userSet",
    components: {
      VerifyButton
    },
    data() {
      var validateOldPass = (rule, value, callback) => {
        if (!value) {
          return callback(new Error('è¯·è¾“å…¥æ—§å¯†ç '));
        } else {
          callback();
        }
      };
      var validatePass = (rule, value, callback) => {
        if (value === '') {
          callback(new Error('è¯·è¾“å…¥æ–°å¯†ç '));
        } else {
          if (this.pwdRuleForm.checkPass !== '') {
            this.$refs.pwdRuleForm.validateField('checkPass');
          }
          callback();
        }
      };
      var validateCheckPass = (rule, value, callback) => {
        if (value === '') {
          callback(new Error('è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç '));
        } else if (value !== this.pwdRuleForm.pass) {
          callback(new Error('ä¸¤æ¬¡è¾“å…¥å¯†ç ä¸ä¸€è‡´'));
        } else {
          callback();
        }
      };
      return {
        safeLevel: 4,
        colors: ['#fe', '#F7BA2A', '#FF9900'],
        userSetTabsValue: 'home',
        setVerify: '',
        bindTelephone: '',
        setTelephone: '',
        isSendSuccess: false,
        isNextByUpdateTel: false,
        pwdRuleForm: {
          oldPass: '',
          pass: '',
          checkPass: ''
        },
        rules: {
          oldPass: [
            {validator: validateOldPass, trigger: 'blur'}
          ],
          pass: [
            {validator: validatePass, trigger: 'blur'}
          ],
          checkPass: [
            {validator: validateCheckPass, trigger: 'blur'}
          ]
        }
      };
    },
    computed: {
      ...mapGetters([
        'userInfo'
      ]),
      verifyBtonStyle() {
        return {
          backgroundColor: '#fe0000',
          color: '#ffffff'
        }
      },
      CountDown() {
        if (this.second === 0) {
          return "å‘é€éªŒè¯ç "
        } else if (this.isSendSuccess) {
          return this.second + "s åé‡æ–°å‘é€"
        } else {
          return "å‘é€éªŒè¯ç "
        }
      },
      isShowStyle() {
        if (this.regTelephone === '')
          return ''
        else if (this.isSendSuccess === true)
          return ''
        else
          return this.verifyBtonStyle
      },
      isDisabled() {
        if (this.regTelephone === '')
          return true
        else if (this.isSendSuccess === true)
          return true
        else
          return false
      }
    },
    methods: {
      //åˆ‡æ¢è´¦æˆ·è®¾ç½®Tabsè§¦å‘
      userSetClickTrigger(targetName) {
        this.setTelephone = ''
        this.setVerify = ''
        this.isSendSuccess = false
      },
      //ä¿®æ”¹å¯†ç æŒ‰é’®
      updatePwdHandler(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            updatePassword({
              userId: this.userInfo.id,
              oldPassword: this.pwdRuleForm.oldPass,
              newPassword: this.pwdRuleForm.pass
            }).then(response => {
              this.$tip.success('ä¿®æ”¹æˆåŠŸ')
              setTimeout(() => {
                this.$store.dispatch('Logout').then(() => {
                  document.getElementById('nav-logo').click()
                })
              }, 1500)
            })
          } else {
            return false;
          }
        });
      },
      resetPwd(formName) {
        this.$refs[formName].resetFields();
      },
      //ç»‘å®šæ‰‹æœºå·
      bindTelHandler(){
        this.$tip.error('è¯¥åŠŸèƒ½æœªä¸Šçº¿')
      },
      //ä¿®æ”¹æ‰‹æœºå·ä¸‹ä¸€æ­¥
      updateTelNextHandler() {
        if(this.userInfo.telephone === '' || this.userInfo.telephone === null) this.$tip.error('è¯·ç»‘å®šæ‰‹æœºå·')
        else if (!this.isSendSuccess) this.$tip.error('è¯·å‘é€éªŒè¯ç ')
        else if (this.setVerify === '') this.$tip.error('éªŒè¯ç ä¸èƒ½ä¸ºç©º')
        else {
          this.isNextByUpdateTel = true
          this.isSendSuccess = false
          this.setVerify = ''
          this.$refs.prevVerifyBtnRef.closeTimer()
        }
      },
      //ä¿®æ”¹æ‰‹æœºå·
      updateTelHandler() {
        if (this.setTelephone === '') {
          this.$tip.error('æ‰‹æœºå·ä¸èƒ½ä¸ºç©º')
        } else if (!this.isSendSuccess) {
          this.$tip.error('è¯·å‘é€éªŒè¯ç ')
        } else if (this.setVerify === '') {
          this.$tip.error('éªŒè¯ç ä¸èƒ½ä¸ºç©º')
        } else {
          updateTelephone({
            userId: this.userInfo.id,
            oldTelephone:this.userInfo.telephone,
            newTelephone: this.setTelephone,
            setVerify: this.setVerify
          }).then(response => {
            this.$tip.success('ä¿®æ”¹æˆåŠŸ')
            this.userSetTabsValue = 'home'
          })
        }
      },
      //è®¾ç½®éªŒè¯ç æŒ‰é’®å‘é€çŠ¶æ€
      setSendSuccessStatus(status) {
        this.isSendSuccess = status
      }
    },
    filters: {
      telephoneFormat(val) {
        if(val !== null){
          return val.substring(0, 3) + "****" + val.substring(7)
        }else {
          return val
        }
      }
    }
  }
</script>

<style lang="scss" scoped>
  #user-set {
    //é¦–é¡µ
    .user-set-home-wrapper {
      padding: 0 20px;
      .ush-title-name {
        width: 150px;
        height: 30px;
        line-height: 31px;
        text-align: center;
        background-color: #333333;
        span {
          color: white;
          font-size: 16px;
        }
      }
      .ush-row-one-wrapper {
        height: 40px;
        .ush-text-top {
          font-size: 20px;
          font-weight: bold;
          float: left;
        }
        .ush-rate {
          padding-top: 3px;
          float: left;
        }
        .ush-img {
          float: left;
          margin-left: 18px;
          margin-top: -3px;
        }
      }
      .usht-text-wrapper {
        float: left;
        margin-left: 8px;
        color: #2BBA4D;
      }
      .ush-row-two-wrapper {
        margin-top: 34px;
        .ush-two-wrapper {
          margin-top: 40px;
          padding: 0 80px;
          .usht-img-wrapper {
            float: left;
          }
        }
      }
      .ush-row-three-wrapper {
        margin-top: 40px;
        .ush-three-wrapper {
          margin-top: 40px;
          padding: 0 80px;
          .usht-left {
            float: left;
          }
        }
      }
    }
    //æ ‡é¢˜
    .us-title-wrapper {
      span {
        font-size: 20px;
        font-weight: bold;
      }
    }
    //ä¿®æ”¹å¯†ç 
    .user-set-password-wrapper {
      padding: 0px 20px;
      .us-password-wrapper {
        padding: 30px 200px 0 100px;
      }
    }
    //ä¿®æ”¹æ‰‹æœº
    .user-set-telephone-wrapper {
      padding: 0px 20px;
      .us-telephone-wrapper {
        padding: 30px 200px 0 170px;
        .us-telephone-tip{
          margin-top: -10px;
          text-align: center;
          font-size: 13px;
          color: #bbbbbb;
          margin-bottom: 40px;
        }
        .us-verify-button {
          margin-left: 10px;
          padding: 8px 0px;
          width: 110px;
          background-color: #F7F7F7;
          border: 1px solid #F7F7F7;
          color: #C4C4C4;
          font-size: 12px;
        }
      }
    }
    //ç»‘å®šé‚®ç®±
    .user-set-email-wrapper {
      padding: 0px 20px;
    }
    //ç»‘å®šè´¦å·
    .user-set-oauth-wrapper {
      padding: 0px 20px;
    }
    //ç™»å½•è®°å½•
    .user-set-record-wrapper {
      padding: 0px 20px;
    }
  }
</style>
